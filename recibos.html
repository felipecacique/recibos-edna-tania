<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Recibos - Edna e T√¢nia</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Recibos">
    <meta name="description" content="Controle de recibos para Edna e T√¢nia">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlJlY2lib3MgLSBFZG5hIGUgVMOibmlhIiwKICAic2hvcnRfbmFtZSI6ICJSZWNpYm9zIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjNEY0NkU1IiwKICAidGhlbWVfY29sb3IiOiAiIzRGNDZFNSIsCiAgImRlc2NyaXB0aW9uIjogIkNvbnRyb2xlIGRlIHJlY2lib3MgcGFyYSBFZG5hIGUgVMOibmlhIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQtcHJpbWFyeSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnPjxyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyBmaWxsPScjNEY0NkU1Jz48L3JlY3Q+PHRleHQgeD0nNTAlJyB5PSc2MCUnIGZvbnQtc2l6ZT0nNDUnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJz7wn5ONPC90ZXh0Pjwvc3ZnPiIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgdmlld0JveD0nMCAwIDEwMCAxMDAnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc+PHJlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyM0RjQ2RTUnPjwvcmVjdD48dGV4dCB4PSc1MCUnIHk9JzYwJScgZm9udC1zaXplPSc0NScgZmlsbD0nd2hpdGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnPvCfk408L3RleHQ+PC9zdmc+IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">
    
    <!-- √çcones Apple -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'><rect width='100' height='100' fill='%234F46E5'></rect><text x='50%' y='60%' font-size='45' fill='white' text-anchor='middle'>üìã</text></svg>">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'><rect width='100' height='100' fill='%234F46E5'></rect><text x='50%' y='60%' font-size='45' fill='white' text-anchor='middle'>üìã</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">Carregando...</div>

    <script>
        // App State
        let state = {
            activeTab: 'inicio',
            recibos: [],
            showAddForm: false,
            viewMode: 'mes',
            selectedDate: new Date(),
            editingId: null,
            formData: {
                nome: '',
                data: new Date().toISOString().split('T')[0],
                descricao: '',
                valor: '',
                categoria: 'Outros',
                foto: null,
                fotoNome: ''
            }
        };

        const categorias = [
            'Taxi/Transporte',
            'Roupas', 
            'Medicamentos',
            'Alimenta√ß√£o',
            'Casa/Utilidades',
            'Outros'
        ];

        // Database para fotos
        let db = null;
        
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('RecibosDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('fotos')) {
                        db.createObjectStore('fotos', { keyPath: 'nome' });
                    }
                };
            });
        }

        function salvarFoto(nome, dadosFoto) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database n√£o inicializado');
                    return;
                }
                
                const transaction = db.transaction(['fotos'], 'readwrite');
                const store = transaction.objectStore('fotos');
                const request = store.put({ nome: nome, dados: dadosFoto });
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function carregarFoto(nome) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database n√£o inicializado');
                    return;
                }
                
                const transaction = db.transaction(['fotos'], 'readonly');
                const store = transaction.objectStore('fotos');
                const request = store.get(nome);
                
                request.onsuccess = () => {
                    resolve(request.result ? request.result.dados : null);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function gerarNomeFoto() {
            const agora = new Date();
            const ano = agora.getFullYear();
            const mes = String(agora.getMonth() + 1).padStart(2, '0');
            const dia = String(agora.getDate()).padStart(2, '0');
            const hora = String(agora.getHours()).padStart(2, '0');
            const min = String(agora.getMinutes()).padStart(2, '0');
            const seg = String(agora.getSeconds()).padStart(2, '0');
            
            const nome = state.formData.nome || 'Recibo';
            const valor = state.formData.valor.replace(',', '-').replace('.', '-') || '00-00';
            
            return `${ano}-${mes}-${dia}_${hora}${min}${seg}_${nome}_${valor}.webp`;
        }

        // Compress√£o inteligente de fotos
        function comprimirFoto(file, maxWidth = 2048, quality = 0.95) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Calcula dimens√µes mantendo propor√ß√£o
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Desenha imagem redimensionada
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Tenta WebP primeiro (melhor compress√£o)
                    canvas.toBlob((webpBlob) => {
                        if (webpBlob) {
                            // WebP funcionou
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(webpBlob);
                        } else {
                            // Fallback para JPEG
                            canvas.toBlob((jpegBlob) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(jpegBlob);
                            }, 'image/jpeg', quality);
                        }
                    }, 'image/webp', quality);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('recibos-data');
                if (saved) {
                    state.recibos = JSON.parse(saved);
                }
            } catch (e) {
                console.log('Erro ao carregar dados:', e);
                state.recibos = [];
            }
            
            initDB().catch(err => console.log('Erro ao inicializar DB:', err));
        }

        function saveData() {
            try {
                localStorage.setItem('recibos-data', JSON.stringify(state.recibos));
                // Atualiza CSV automaticamente a cada mudan√ßa
                salvarCSVAtualizado();
            } catch (e) {
                console.log('Erro ao salvar dados:', e);
            }
        }

        // Configura√ß√£o salvamento (x recibos)
        const CONFIG_SALVAMENTO = {
            frequencia: 1, // Salva a cada X recibos
            contador: 0    // Contador atual
        };
        
        // Sistema de Storage Inteligente
        async function salvarCSVAtualizado(forcado = false) {
            // Incrementa contador apenas se n√£o for for√ßado
            if (!forcado) {
                CONFIG_SALVAMENTO.contador++;
                // S√≥ salva se atingiu a frequ√™ncia
                if (CONFIG_SALVAMENTO.contador < CONFIG_SALVAMENTO.frequencia) {
                    return;
                }
                // Reset contador
                CONFIG_SALVAMENTO.contador = 0;
            }
            try {
                const headers = 'Data;Nome;Descri√ß√£o;Valor;Categoria;M√™s;Ano;Foto\n';
                const csvContent = state.recibos.map(r => {
                    const data = new Date(r.data);
                    const mes = data.toLocaleDateString('pt-BR', { month: 'long' });
                    const ano = data.getFullYear();
                    const foto = r.fotoNome || '';
                    return `${data.toLocaleDateString('pt-BR')};${r.nome};${r.descricao};${r.valor.toFixed(2).replace('.', ',')};${r.categoria};${mes};${ano};${foto}`;
                }).join('\n');
                
                const csvFinal = headers + csvContent;
                const timestamp = new Date().toISOString();
                
                // Salva CSV sempre atualizado
                localStorage.setItem('recibos-csv-atual', csvFinal);
                localStorage.setItem('recibos-csv-timestamp', timestamp);
                
                // Download autom√°tico do CSV atualizado na pasta recibos
                downloadCSVAutomatico(csvFinal, '[RECIBOS] recibos_completo.csv');
                
                console.log('CSV atualizado automaticamente');
            } catch (e) {
                console.log('Erro ao salvar CSV:', e);
            }
        }

        function downloadCSVAutomatico(csvContent, nomeArquivo) {
            try {
                // Verifica se deve fazer download autom√°tico (evita spam de downloads)
                const ultimoDownload = localStorage.getItem('ultimo-download-csv');
                const agora = Date.now();
                const intervaloMinimo = 5000; // 5 segundos entre downloads
                
                if (!ultimoDownload || (agora - parseInt(ultimoDownload)) >= intervaloMinimo) {
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = nomeArquivo;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    localStorage.setItem('ultimo-download-csv', agora.toString());
                    console.log('CSV baixado automaticamente:', nomeArquivo);
                }
            } catch (e) {
                console.log('Erro no download autom√°tico:', e);
            }
        }

        async function salvarFotoPersistente(nomeArquivo, dadosFoto) {
            try {
                // Salva no storage persistente (localStorage para fotos pequenas comprimidas)
                const fotoKey = `foto-storage-${nomeArquivo}`;
                localStorage.setItem(fotoKey, dadosFoto);
                
                // Salva tamb√©m no cache IndexedDB para acesso r√°pido
                await salvarFoto(nomeArquivo, dadosFoto);
                
                // Gerencia cache inteligente
                await gerenciarCacheInteligente();
                
                // Download autom√°tico da foto para subpasta imagens
                downloadFotoAutomatico(dadosFoto, '[IMAGEM] ' + nomeArquivo);
                
                console.log('Foto salva no storage persistente e cache');
            } catch (e) {
                console.log('Erro ao salvar foto persistente:', e);
            }
        }

        function downloadFotoAutomatico(dadosFoto, nomeArquivo) {
            try {
                // Converte base64 para blob
                const base64Data = dadosFoto.split(',')[1];
                const mimeType = dadosFoto.split(',')[0].split(':')[1].split(';')[0];
                
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mimeType });
                
                // Download da foto
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nomeArquivo;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                console.log('Foto baixada automaticamente:', nomeArquivo);
            } catch (e) {
                console.log('Erro no download autom√°tico da foto:', e);
            }
        }

        async function gerenciarCacheInteligente() {
            try {
                if (!db) return;
                
                const transaction = db.transaction(['fotos'], 'readonly');
                const store = transaction.objectStore('fotos');
                const request = store.getAll();
                
                request.onsuccess = async () => {
                    const todasFotos = request.result;
                    const limiteFotos = 10;
                    
                    // Se tem mais de 10 fotos no cache, remove as mais antigas
                    if (todasFotos.length > limiteFotos) {
                        // Ordena por nome (que tem timestamp) - mais antigas primeiro
                        const fotosOrdenadas = todasFotos.sort((a, b) => a.nome.localeCompare(b.nome));
                        const fotosParaRemover = fotosOrdenadas.slice(0, todasFotos.length - limiteFotos);
                        
                        const deleteTransaction = db.transaction(['fotos'], 'readwrite');
                        const deleteStore = deleteTransaction.objectStore('fotos');
                        
                        fotosParaRemover.forEach(foto => {
                            deleteStore.delete(foto.nome);
                            console.log(`Foto removida do cache: ${foto.nome}`);
                        });
                    }
                    
                    // Verifica uso de storage
                    await verificarUsageStorage();
                };
            } catch (e) {
                console.log('Erro ao gerenciar cache:', e);
            }
        }

        async function verificarUsageStorage() {
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usado = estimate.usage || 0;
                    const disponivel = estimate.quota || 0;
                    const percentual = (usado / disponivel) * 100;
                    
                    console.log(`Storage: ${(usado/1024/1024).toFixed(2)}MB / ${(disponivel/1024/1024).toFixed(2)}MB (${percentual.toFixed(1)}%)`);
                    
                    // Se usar mais de 50% do storage, limpa cache mais agressivamente
                    if (percentual > 50) {
                        await limpezaCacheAgressiva();
                    }
                }
            } catch (e) {
                console.log('Erro ao verificar storage:', e);
            }
        }

        async function limpezaCacheAgressiva() {
            try {
                if (!db) return;
                
                const transaction = db.transaction(['fotos'], 'readwrite');
                const store = transaction.objectStore('fotos');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const todasFotos = request.result;
                    // Mant√©m apenas as 5 fotos mais recentes em cache agressivo
                    const fotosOrdenadas = todasFotos.sort((a, b) => b.nome.localeCompare(a.nome));
                    const fotosParaRemover = fotosOrdenadas.slice(5);
                    
                    fotosParaRemover.forEach(foto => {
                        store.delete(foto.nome);
                        console.log(`Cache agressivo - foto removida: ${foto.nome}`);
                    });
                };
            } catch (e) {
                console.log('Erro na limpeza agressiva:', e);
            }
        }

        async function carregarFotoInteligente(nomeArquivo) {
            try {
                // Primeiro tenta do cache IndexedDB (mais r√°pido)
                const dadosCache = await carregarFoto(nomeArquivo);
                if (dadosCache) {
                    return dadosCache;
                }
                
                // Se n√£o est√° no cache, carrega do storage persistente
                const fotoKey = `foto-storage-${nomeArquivo}`;
                const dadosStorage = localStorage.getItem(fotoKey);
                if (dadosStorage) {
                    // Recoloca no cache para pr√≥ximos acessos
                    await salvarFoto(nomeArquivo, dadosStorage);
                    return dadosStorage;
                }
                
                return null;
            } catch (e) {
                console.log('Erro ao carregar foto inteligente:', e);
                return null;
            }
        }

        function criarBackupSemanal() {
            try {
                const agora = new Date();
                const csvAtual = localStorage.getItem('recibos-csv-atual');
                
                if (csvAtual) {
                    const nomeBackup = `recibos_backup_${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}-${String(agora.getDate()).padStart(2, '0')}.csv`;
                    const backupKey = `backup-${agora.getTime()}`;
                    
                    const backup = {
                        nome: nomeBackup,
                        data: agora.toISOString(),
                        conteudo: csvAtual
                    };
                    
                    localStorage.setItem(backupKey, JSON.stringify(backup));
                    
                    // Atualiza lista de backups
                    const backupsExistentes = JSON.parse(localStorage.getItem('lista-backups') || '[]');
                    backupsExistentes.push({
                        key: backupKey,
                        nome: nomeBackup,
                        data: agora.toISOString()
                    });
                    
                    // Mant√©m apenas os √∫ltimos 10 backups
                    const backupsLimitados = backupsExistentes.slice(-10);
                    localStorage.setItem('lista-backups', JSON.stringify(backupsLimitados));
                    
                    // Download autom√°tico do backup na subpasta backups
                    downloadCSVAutomatico(csvAtual, '[BACKUP] ' + nomeBackup);
                    
                    console.log('Backup semanal criado:', nomeBackup);
                    return nomeBackup;
                }
            } catch (e) {
                console.log('Erro ao criar backup:', e);
            }
        }

        function setState(newState) {
            Object.assign(state, newState);
            render();
        }

        function navigateDate(direction) {
            const newDate = new Date(state.selectedDate);
            if (state.viewMode === 'mes') {
                newDate.setMonth(newDate.getMonth() + direction);
            } else {
                newDate.setFullYear(newDate.getFullYear() + direction);
            }
            setState({ selectedDate: newDate });
        }

        function getDateLabel() {
            if (state.viewMode === 'mes') {
                return state.selectedDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            } else {
                return state.selectedDate.getFullYear().toString();
            }
        }

        function getRecibosContextuais() {
            if (state.viewMode === 'mes') {
                return state.recibos.filter(r => {
                    const dataRecibo = new Date(r.data);
                    return dataRecibo.getMonth() === state.selectedDate.getMonth() && 
                           dataRecibo.getFullYear() === state.selectedDate.getFullYear();
                });
            } else {
                return state.recibos.filter(r => {
                    const dataRecibo = new Date(r.data);
                    return dataRecibo.getFullYear() === state.selectedDate.getFullYear();
                });
            }
        }

        function getTotaisPorPessoa(recibosList) {
            if (!recibosList) recibosList = getRecibosContextuais();
            const totais = { Edna: 0, T√¢nia: 0 };
            recibosList.forEach(r => {
                totais[r.nome] = (totais[r.nome] || 0) + r.valor;
            });
            return totais;
        }

        function handleAddRecibo() {
            if (!state.formData.nome || !state.formData.descricao || !state.formData.valor) {
                alert('Por favor, preencha todos os campos obrigat√≥rios');
                return;
            }

            const valorNumerico = parseFloat(state.formData.valor.toString().replace(',', '.'));
            if (isNaN(valorNumerico) || valorNumerico <= 0) {
                alert('Por favor, digite um valor v√°lido maior que zero');
                return;
            }

            const reciboData = {
                nome: state.formData.nome,
                data: state.formData.data,
                descricao: state.formData.descricao,
                valor: valorNumerico,
                categoria: state.formData.categoria,
                fotoNome: state.formData.fotoNome || null
            };

            if (state.editingId) {
                const index = state.recibos.findIndex(r => r.id === state.editingId);
                if (index !== -1) {
                    state.recibos[index] = {
                        ...state.recibos[index],
                        ...reciboData,
                        editadoEm: new Date().toISOString()
                    };
                }
            } else {
                const novoRecibo = {
                    id: Date.now(),
                    ...reciboData,
                    dataAdd: new Date().toISOString()
                };
                state.recibos = [novoRecibo, ...state.recibos];
            }

            saveData();
            
            setState({
                formData: {
                    nome: '',
                    data: new Date().toISOString().split('T')[0],
                    descricao: '',
                    valor: '',
                    categoria: 'Outros',
                    foto: null,
                    fotoNome: ''
                },
                showAddForm: false,
                editingId: null,
                activeTab: 'inicio'
            });
        }

        function editRecibo(id) {
            const recibo = state.recibos.find(r => r.id === id);
            if (recibo) {
                setState({
                    formData: {
                        nome: recibo.nome,
                        data: recibo.data,
                        descricao: recibo.descricao,
                        valor: recibo.valor.toString().replace('.', ','),
                        categoria: recibo.categoria,
                        foto: null,
                        fotoNome: recibo.fotoNome || ''
                    },
                    showAddForm: true,
                    editingId: id
                });
            }
        }

        function deleteRecibo(id) {
            if (confirm('Tem certeza que deseja excluir este recibo?')) {
                state.recibos = state.recibos.filter(r => r.id !== id);
                saveData();
                render();
            }
        }

        function tirarFoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    try {
                        // Comprime foto (2MB ‚Üí ~200KB)
                        const fotoComprimida = await comprimirFoto(file);
                        const nomeArquivo = gerarNomeFoto();
                        
                        // Salva foto no storage persistente e cache
                        await salvarFotoPersistente(nomeArquivo, fotoComprimida);
                        
                        state.formData.foto = fotoComprimida;
                        state.formData.fotoNome = nomeArquivo;
                        
                        render();
                    } catch (err) {
                        console.error('Erro ao processar foto:', err);
                        alert('Erro ao processar foto. Tente novamente.');
                    }
                }
            };
            
            input.click();
        }

        function removerFoto() {
            state.formData.foto = null;
            state.formData.fotoNome = '';
            render();
        }

        async function gerarZIPCompleto() {
            if (!window.JSZip) {
                throw new Error('JSZip n√£o carregado');
            }

            const zip = new JSZip();
            
            const headers = 'Data;Nome;Descri√ß√£o;Valor;Categoria;M√™s;Ano;Foto\n';
            const csvContent = state.recibos.map(r => {
                const data = new Date(r.data);
                const mes = data.toLocaleDateString('pt-BR', { month: 'long' });
                const ano = data.getFullYear();
                const foto = r.fotoNome || '';
                return `${data.toLocaleDateString('pt-BR')};${r.nome};${r.descricao};${r.valor.toFixed(2).replace('.', ',')};${r.categoria};${mes};${ano};${foto}`;
            }).join('\n');
            
            const csvFinal = headers + csvContent;
            const nomeCSV = `recibos_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
            
            zip.file(nomeCSV, csvFinal);
            
            const fotosFolder = zip.folder('fotos');
            const fotosComPromise = state.recibos
                .filter(r => r.fotoNome)
                .map(async r => {
                    try {
                        const dadosFoto = await carregarFotoInteligente(r.fotoNome);
                        if (dadosFoto) {
                            const base64Data = dadosFoto.split(',')[1];
                            fotosFolder.file(r.fotoNome, base64Data, { base64: true });
                        }
                    } catch (err) {
                        console.error('Erro ao carregar foto:', r.fotoNome, err);
                    }
                });
            
            await Promise.all(fotosComPromise);
            
            return await zip.generateAsync({ type: 'blob' });
        }

        function compartilharWhatsApp() {
            gerarZIPCompleto().then(zipBlob => {
                const nomeArquivo = `Backup_Completo_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.zip`;
                const file = new File([zipBlob], nomeArquivo, { type: 'application/zip' });
                
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    const totaisGerais = getTotaisPorPessoa(state.recibos);
                    const totalGeral = totaisGerais.Edna + totaisGerais.T√¢nia;
                    
                    const mensagem = `üìã BACKUP COMPLETO - Todos os Recibos\n\n` +
                        `üí∞ Edna: R$ ${totaisGerais.Edna.toFixed(2).replace('.', ',')}\n` +
                        `üí∞ T√¢nia: R$ ${totaisGerais.T√¢nia.toFixed(2).replace('.', ',')}\n` +
                        `üìä TOTAL GERAL: R$ ${totalGeral.toFixed(2).replace('.', ',')}\n` +
                        `üóÇÔ∏è Total de recibos: ${state.recibos.length}\n\n` +
                        `üì¶ Arquivo ZIP com CSV + todas as fotos dos recibos!`;
                    
                    navigator.share({
                        title: 'Backup de Recibos - Edna e T√¢nia',
                        text: mensagem,
                        files: [file]
                    }).catch(err => {
                        downloadZIP(zipBlob, nomeArquivo);
                        abrirWhatsAppComMensagemZIP();
                    });
                } else {
                    downloadZIP(zipBlob, nomeArquivo);
                    setTimeout(abrirWhatsAppComMensagemZIP, 1000);
                }
            }).catch(err => {
                console.error('Erro ao gerar ZIP:', err);
                alert('Erro ao gerar backup. Tente novamente.');
            });
        }

        function downloadZIP(zipBlob, nomeArquivo) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = nomeArquivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
        
        function abrirWhatsAppComMensagemZIP() {
            const totaisGerais = getTotaisPorPessoa(state.recibos);
            const totalGeral = totaisGerais.Edna + totaisGerais.T√¢nia;
            
            const mensagem = `üìã BACKUP COMPLETO - Todos os Recibos\n\n` +
                `üí∞ Edna: R$ ${totaisGerais.Edna.toFixed(2).replace('.', ',')}\n` +
                `üí∞ T√¢nia: R$ ${totaisGerais.T√¢nia.toFixed(2).replace('.', ',')}\n` +
                `üìä TOTAL GERAL: R$ ${totalGeral.toFixed(2).replace('.', ',')}\n` +
                `üóÇÔ∏è Total de recibos: ${state.recibos.length}\n\n` +
                `üì¶ Arquivo ZIP baixado com CSV + todas as fotos!\n` +
                `üìÇ V√° nos Downloads e anexe na conversa`;
            
            const urlWhats = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
            window.open(urlWhats, '_blank');
        }

        function exportarCSV(periodo) {
            let dadosExport = [];
            let nomeArquivo = '';
            
            if (periodo === 'atual') {
                dadosExport = getRecibosContextuais();
                nomeArquivo = state.viewMode === 'mes' 
                    ? `Recibos_${getDateLabel().replace(' ', '_')}.csv`
                    : `Recibos_Ano_${state.selectedDate.getFullYear()}.csv`;
            } else {
                dadosExport = state.recibos;
                nomeArquivo = `Backup_Completo_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
            }

            const headers = 'Data;Nome;Descri√ß√£o;Valor;Categoria;M√™s;Ano;Foto\n';
            const csvContent = dadosExport.map(r => {
                const data = new Date(r.data);
                const mes = data.toLocaleDateString('pt-BR', { month: 'long' });
                const ano = data.getFullYear();
                const foto = r.fotoNome || '';
                return `${data.toLocaleDateString('pt-BR')};${r.nome};${r.descricao};${r.valor.toFixed(2).replace('.', ',')};${r.categoria};${mes};${ano};${foto}`;
            }).join('\n');

            const csvFinal = headers + csvContent;
            downloadCSV(csvFinal, nomeArquivo);
            return nomeArquivo;
        }

        function downloadCSV(csvContent, nomeArquivo) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = nomeArquivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function carregarBackup(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const conteudo = e.target.result;
                    const linhas = conteudo.split('\n').slice(1);
                    const novosRecibos = [];
                    let fotosImportadas = 0;

                    linhas.forEach((linha, index) => {
                        if (linha.trim()) {
                            const [data, nome, descricao, valor, categoria, mes, ano, foto] = linha.split(';');
                            if (data && nome && descricao && valor) {
                                const recibo = {
                                    id: `imported_${Date.now()}_${index}`,
                                    data: data.includes('/') ? data.split('/').reverse().join('-') : data,
                                    nome: nome.trim(),
                                    descricao: descricao.trim(),
                                    valor: parseFloat(valor.replace(',', '.')),
                                    categoria: categoria ? categoria.trim() : 'Outros',
                                    dataAdd: new Date().toISOString()
                                };
                                
                                // Preserva foto se existir
                                if (foto && foto.trim()) {
                                    recibo.fotoNome = foto.trim();
                                    fotosImportadas++;
                                }
                                
                                // Verifica duplicatas baseado em data+nome+valor
                                const chave = `${recibo.data}_${recibo.nome}_${recibo.valor}`;
                                const jaExiste = state.recibos.some(r => 
                                    `${r.data}_${r.nome}_${r.valor}` === chave
                                );
                                
                                if (!jaExiste) {
                                    novosRecibos.push(recibo);
                                }
                            }
                        }
                    });

                    if (novosRecibos.length > 0) {
                        state.recibos = [...novosRecibos, ...state.recibos];
                        saveData();
                        salvarCSVAtualizado(true); // For√ßa salvamento
                        render();
                        
                        const mensagem = `‚úÖ ${novosRecibos.length} recibos importados com sucesso!`;
                        if (fotosImportadas > 0) {
                            alert(`${mensagem}\nüì∑ ${fotosImportadas} fotos referenciadas (voc√™ pode precisar re-adicionar as fotos manualmente)`);
                        } else {
                            alert(mensagem);
                        }
                    } else {
                        alert('‚ùå Nenhum recibo v√°lido encontrado no arquivo.');
                    }
                } catch (error) {
                    alert('‚ùå Erro ao carregar arquivo. Verifique se √© um CSV v√°lido.');
                }
            };
            reader.readAsText(arquivo);
            event.target.value = '';
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            
            app.innerHTML = '';
            
            // Header
            const header = document.createElement('div');
            header.className = 'bg-gradient-to-r from-blue-600 to-purple-700 text-white p-4 shadow-lg';
            
            const h1 = document.createElement('h1');
            h1.className = 'text-2xl font-bold text-center';
            h1.textContent = 'Controle de Recibos';
            header.appendChild(h1);
            
            const p = document.createElement('p');
            p.className = 'text-center opacity-90';
            p.textContent = 'Edna e T√¢nia';
            header.appendChild(p);
            
            app.appendChild(header);
            
            // Content area
            const content = document.createElement('div');
            content.className = 'pb-20';
            
            if (state.showAddForm) {
                content.appendChild(createFormulario());
            } else if (state.activeTab === 'inicio') {
                content.appendChild(createTelaInicio());
            } else if (state.activeTab === 'relatorios') {
                content.appendChild(createTelaRelatorios());
            }
            
            app.appendChild(content);
            
            // Bottom menu
            if (!state.showAddForm) {
                const menu = document.createElement('div');
                menu.className = 'fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg flex';
                
                const inicioBtn = document.createElement('button');
                inicioBtn.className = `flex-1 py-4 flex flex-col items-center gap-1 ${state.activeTab === 'inicio' ? 'text-blue-600 bg-blue-50' : 'text-gray-600'}`;
                inicioBtn.onclick = () => setState({ activeTab: 'inicio' });
                
                const inicioIcon = document.createElement('span');
                inicioIcon.style.fontSize = '20px';
                inicioIcon.textContent = 'üìÑ';
                inicioBtn.appendChild(inicioIcon);
                
                const inicioText = document.createElement('span');
                inicioText.className = 'text-sm font-medium';
                inicioText.textContent = 'In√≠cio';
                inicioBtn.appendChild(inicioText);
                
                const addBtn = document.createElement('button');
                addBtn.className = 'flex-1 py-4 flex flex-col items-center gap-1 text-green-600 bg-green-50';
                addBtn.onclick = () => setState({ showAddForm: true });
                
                const addIcon = document.createElement('span');
                addIcon.style.fontSize = '20px';
                addIcon.textContent = '‚ûï';
                addBtn.appendChild(addIcon);
                
                const addText = document.createElement('span');
                addText.className = 'text-sm font-medium';
                addText.textContent = 'Adicionar';
                addBtn.appendChild(addText);
                
                const relBtn = document.createElement('button');
                relBtn.className = `flex-1 py-4 flex flex-col items-center gap-1 ${state.activeTab === 'relatorios' ? 'text-purple-600 bg-purple-50' : 'text-gray-600'}`;
                relBtn.onclick = () => setState({ activeTab: 'relatorios' });
                
                const relIcon = document.createElement('span');
                relIcon.style.fontSize = '20px';
                relIcon.textContent = 'üìä';
                relBtn.appendChild(relIcon);
                
                const relText = document.createElement('span');
                relText.className = 'text-sm font-medium';
                relText.textContent = 'Relat√≥rios';
                relBtn.appendChild(relText);
                
                menu.appendChild(inicioBtn);
                menu.appendChild(addBtn);
                menu.appendChild(relBtn);
                app.appendChild(menu);
            }
        }

        function createFormulario() {
            const container = document.createElement('div');
            container.className = 'p-4 space-y-6';
            
            const title = document.createElement('h2');
            title.className = 'text-2xl font-bold text-center text-gray-800 mb-6';
            title.textContent = state.editingId ? 'Editar Recibo' : 'Adicionar Recibo';
            container.appendChild(title);
            
            // Quem gastou
            const quemDiv = document.createElement('div');
            quemDiv.className = 'space-y-2';
            
            const quemLabel = document.createElement('label');
            quemLabel.className = 'block text-lg font-medium text-gray-700';
            quemLabel.textContent = 'Quem gastou?';
            quemDiv.appendChild(quemLabel);
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'flex gap-3';
            
            const ednaBtn = document.createElement('button');
            ednaBtn.textContent = 'EDNA';
            ednaBtn.className = `flex-1 py-4 px-6 text-xl font-bold rounded-lg ${state.formData.nome === 'Edna' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'}`;
            ednaBtn.onclick = () => {
                state.formData.nome = 'Edna';
                render();
            };
            
            const taniaBtn = document.createElement('button');
            taniaBtn.textContent = 'T√ÇNIA';
            taniaBtn.className = `flex-1 py-4 px-6 text-xl font-bold rounded-lg ${state.formData.nome === 'T√¢nia' ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-700'}`;
            taniaBtn.onclick = () => {
                state.formData.nome = 'T√¢nia';
                render();
            };
            
            buttonsDiv.appendChild(ednaBtn);
            buttonsDiv.appendChild(taniaBtn);
            quemDiv.appendChild(buttonsDiv);
            container.appendChild(quemDiv);
            
            // Data
            const dataDiv = document.createElement('div');
            dataDiv.className = 'space-y-2';
            
            const dataLabel = document.createElement('label');
            dataLabel.className = 'block text-lg font-medium text-gray-700';
            dataLabel.textContent = 'Data';
            dataDiv.appendChild(dataLabel);
            
            const dataInput = document.createElement('input');
            dataInput.type = 'date';
            dataInput.value = state.formData.data;
            dataInput.className = 'w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500';
            dataInput.addEventListener('change', (e) => {
                state.formData.data = e.target.value;
            });
            dataDiv.appendChild(dataInput);
            container.appendChild(dataDiv);
            
            // Descri√ß√£o
            const descDiv = document.createElement('div');
            descDiv.className = 'space-y-2';
            
            const descLabel = document.createElement('label');
            descLabel.className = 'block text-lg font-medium text-gray-700';
            descLabel.textContent = 'O que foi comprado?';
            descDiv.appendChild(descLabel);
            
            const descInput = document.createElement('input');
            descInput.type = 'text';
            descInput.placeholder = 'Ex: Taxi para m√©dico, Blusa azul...';
            descInput.value = state.formData.descricao;
            descInput.className = 'w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500';
            descInput.addEventListener('change', (e) => {
                state.formData.descricao = e.target.value;
            });
            descDiv.appendChild(descInput);
            container.appendChild(descDiv);
            
            // Valor
            const valorDiv = document.createElement('div');
            valorDiv.className = 'space-y-2';
            
            const valorLabel = document.createElement('label');
            valorLabel.className = 'block text-lg font-medium text-gray-700';
            valorLabel.textContent = 'Valor (R$)';
            valorDiv.appendChild(valorLabel);
            
            const valorInput = document.createElement('input');
            valorInput.type = 'text';
            valorInput.inputMode = 'decimal';
            valorInput.placeholder = '25,50';
            valorInput.value = state.formData.valor;
            valorInput.className = 'w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500';
            
            valorInput.addEventListener('input', (e) => {
                let valor = e.target.value;
                valor = valor.replace(/[^0-9,.]/g, '');
                const virgulas = (valor.match(/[,.]/g) || []).length;
                if (virgulas > 1) {
                    valor = valor.substring(0, valor.lastIndexOf(',')) + valor.substring(valor.lastIndexOf(',') + 1).replace(/[,.]/g, '');
                }
                e.target.value = valor;
            });
            
            valorInput.addEventListener('change', (e) => {
                let valor = e.target.value;
                if (valor) {
                    const valorNumerico = parseFloat(valor.replace(',', '.'));
                    if (!isNaN(valorNumerico) && valorNumerico > 0) {
                        valor = valorNumerico.toFixed(2).replace('.', ',');
                        e.target.value = valor;
                    }
                }
                state.formData.valor = valor;
            });
            
            valorDiv.appendChild(valorInput);
            container.appendChild(valorDiv);
            
            // Categoria
            const catDiv = document.createElement('div');
            catDiv.className = 'space-y-2';
            
            const catLabel = document.createElement('label');
            catLabel.className = 'block text-lg font-medium text-gray-700';
            catLabel.textContent = 'Categoria';
            catDiv.appendChild(catLabel);
            
            const catSelect = document.createElement('select');
            catSelect.value = state.formData.categoria;
            catSelect.className = 'w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500';
            catSelect.addEventListener('change', (e) => {
                state.formData.categoria = e.target.value;
            });
            
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === state.formData.categoria) option.selected = true;
                catSelect.appendChild(option);
            });
            
            catDiv.appendChild(catSelect);
            container.appendChild(catDiv);
            
            // Foto do Recibo
            const fotoDiv = document.createElement('div');
            fotoDiv.className = 'space-y-2';
            
            const fotoLabel = document.createElement('label');
            fotoLabel.className = 'block text-lg font-medium text-gray-700';
            fotoLabel.textContent = 'Foto do Recibo (opcional)';
            fotoDiv.appendChild(fotoLabel);
            
            if (state.formData.foto || state.formData.fotoNome) {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center';
                
                if (state.formData.foto) {
                    const img = document.createElement('img');
                    img.src = state.formData.foto;
                    img.className = 'max-w-full max-h-48 mx-auto rounded';
                    previewDiv.appendChild(img);
                } else if (state.formData.fotoNome) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'text-gray-600';
                    placeholder.textContent = `üì∑ Foto salva: ${state.formData.fotoNome}`;
                    previewDiv.appendChild(placeholder);
                }
                
                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'flex gap-2 mt-3';
                
                const verBtn = document.createElement('button');
                verBtn.textContent = 'üëÅÔ∏è Ver Foto';
                verBtn.className = 'flex-1 py-2 px-4 bg-blue-500 text-white rounded-lg font-bold';
                verBtn.onclick = () => {
                    if (state.formData.foto) {
                        const popup = window.open('', '_blank');
                        popup.document.write(`<img src="${state.formData.foto}" style="max-width:100%; max-height:100vh;">`);
                    } else if (state.formData.fotoNome) {
                        carregarFotoInteligente(state.formData.fotoNome).then(dados => {
                            if (dados) {
                                const popup = window.open('', '_blank');
                                popup.document.write(`<img src="${dados}" style="max-width:100%; max-height:100vh;">`);
                            }
                        });
                    }
                };
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'üóëÔ∏è Remover';
                removeBtn.className = 'flex-1 py-2 px-4 bg-red-500 text-white rounded-lg font-bold';
                removeBtn.onclick = removerFoto;
                
                buttonGroup.appendChild(verBtn);
                buttonGroup.appendChild(removeBtn);
                previewDiv.appendChild(buttonGroup);
                
                fotoDiv.appendChild(previewDiv);
            } else {
                const fotoBtn = document.createElement('button');
                fotoBtn.textContent = 'üì∑ TIRAR FOTO DO RECIBO';
                fotoBtn.type = 'button';
                fotoBtn.className = 'w-full py-4 bg-blue-500 text-white text-lg font-bold rounded-lg border-2 border-dashed border-blue-300 hover:bg-blue-600';
                fotoBtn.onclick = tirarFoto;
                fotoDiv.appendChild(fotoBtn);
            }
            
            container.appendChild(fotoDiv);
            
            // Bot√µes
            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-3 pt-4';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'CANCELAR';
            cancelBtn.className = 'flex-1 py-4 px-6 bg-gray-500 text-white text-xl font-bold rounded-lg';
            cancelBtn.onclick = () => setState({ 
                showAddForm: false, 
                editingId: null,
                formData: {
                    nome: '',
                    data: new Date().toISOString().split('T')[0],
                    descricao: '',
                    valor: '',
                    categoria: 'Outros',
                    foto: null,
                    fotoNome: ''
                }
            });
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = state.editingId ? 'SALVAR ALTERA√á√ïES' : 'SALVAR';
            saveBtn.className = `flex-1 py-4 px-6 text-xl font-bold rounded-lg ${state.editingId ? 'bg-orange-500' : 'bg-green-500'} text-white`;
            saveBtn.onclick = handleAddRecibo;
            
            btnDiv.appendChild(cancelBtn);
            btnDiv.appendChild(saveBtn);
            container.appendChild(btnDiv);
            
            return container;
        }

        function createTelaInicio() {
            const recibosContextuais = getRecibosContextuais();
            const totaisContextuais = getTotaisPorPessoa(recibosContextuais);
            const totalGeral = totaisContextuais.Edna + totaisContextuais.T√¢nia;

            const container = document.createElement('div');
            container.className = 'p-4 space-y-6';
            
            // Bot√£o Adicionar
            const addBtn = document.createElement('button');
            addBtn.className = 'w-full py-6 bg-green-500 text-white text-2xl font-bold rounded-lg flex items-center justify-center gap-3 shadow-lg';
            addBtn.onclick = () => setState({ showAddForm: true });
            
            const addIcon = document.createElement('span');
            addIcon.style.fontSize = '24px';
            addIcon.textContent = '‚ûï';
            addBtn.appendChild(addIcon);
            
            const addText = document.createElement('span');
            addText.textContent = 'ADICIONAR RECIBO';
            addBtn.appendChild(addText);
            
            container.appendChild(addBtn);
            
            // Navega√ß√£o
            const navDiv = document.createElement('div');
            navDiv.className = 'bg-white rounded-lg shadow-lg p-4';
            
            const navControls = document.createElement('div');
            navControls.className = 'flex items-center justify-between mb-4';
            
            const leftBtn = document.createElement('button');
            leftBtn.textContent = '‚óÄÔ∏è';
            leftBtn.className = 'p-3 bg-gray-100 rounded-lg text-xl';
            leftBtn.onclick = () => navigateDate(-1);
            
            const rightBtn = document.createElement('button');
            rightBtn.textContent = '‚ñ∂Ô∏è';
            rightBtn.className = 'p-3 bg-gray-100 rounded-lg text-xl';
            rightBtn.onclick = () => navigateDate(1);
            
            const dateTitle = document.createElement('h2');
            dateTitle.className = 'text-xl font-bold text-gray-800 text-center flex-1 mx-4';
            dateTitle.textContent = getDateLabel();
            
            navControls.appendChild(leftBtn);
            navControls.appendChild(dateTitle);
            navControls.appendChild(rightBtn);
            navDiv.appendChild(navControls);
            
            const toggleDiv = document.createElement('div');
            toggleDiv.className = 'flex gap-2';
            
            const mesBtn = document.createElement('button');
            mesBtn.textContent = 'VER M√äS';
            mesBtn.className = `flex-1 py-2 px-4 text-sm font-bold rounded-lg ${state.viewMode === 'mes' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'}`;
            mesBtn.onclick = () => setState({ viewMode: 'mes' });
            
            const anoBtn = document.createElement('button');
            anoBtn.textContent = 'VER ANO';
            anoBtn.className = `flex-1 py-2 px-4 text-sm font-bold rounded-lg ${state.viewMode === 'ano' ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700'}`;
            anoBtn.onclick = () => setState({ viewMode: 'ano' });
            
            toggleDiv.appendChild(mesBtn);
            toggleDiv.appendChild(anoBtn);
            navDiv.appendChild(toggleDiv);
            container.appendChild(navDiv);
            
            // Resumo
            const resumoDiv = document.createElement('div');
            resumoDiv.className = 'bg-white rounded-lg shadow-lg p-6';
            
            const resumoTitle = document.createElement('h3');
            resumoTitle.className = 'text-lg font-bold text-center text-gray-800 mb-4';
            resumoTitle.textContent = `Resumo - ${getDateLabel()}`;
            resumoDiv.appendChild(resumoTitle);
            
            const resumoContent = document.createElement('div');
            resumoContent.className = 'space-y-3';
            
            // Edna
            const ednaDiv = document.createElement('div');
            ednaDiv.className = 'flex justify-between items-center p-3 bg-blue-50 rounded-lg';
            
            const ednaLabel = document.createElement('span');
            ednaLabel.className = 'text-lg font-medium text-blue-700';
            ednaLabel.textContent = 'Edna:';
            ednaDiv.appendChild(ednaLabel);
            
            const ednaValue = document.createElement('span');
            ednaValue.className = 'text-lg font-bold text-blue-700';
            ednaValue.textContent = `R$ ${totaisContextuais.Edna.toFixed(2).replace('.', ',')} (${recibosContextuais.filter(r => r.nome === 'Edna').length})`;
            ednaDiv.appendChild(ednaValue);
            
            resumoContent.appendChild(ednaDiv);
            
            // T√¢nia
            const taniaDiv = document.createElement('div');
            taniaDiv.className = 'flex justify-between items-center p-3 bg-pink-50 rounded-lg';
            
            const taniaLabel = document.createElement('span');
            taniaLabel.className = 'text-lg font-medium text-pink-700';
            taniaLabel.textContent = 'T√¢nia:';
            taniaDiv.appendChild(taniaLabel);
            
            const taniaValue = document.createElement('span');
            taniaValue.className = 'text-lg font-bold text-pink-700';
            taniaValue.textContent = `R$ ${totaisContextuais.T√¢nia.toFixed(2).replace('.', ',')} (${recibosContextuais.filter(r => r.nome === 'T√¢nia').length})`;
            taniaDiv.appendChild(taniaValue);
            
            resumoContent.appendChild(taniaDiv);
            
            // Total
            const totalDiv = document.createElement('div');
            totalDiv.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg border-2 border-gray-300';
            
            const totalLabel = document.createElement('span');
            totalLabel.className = 'text-lg font-bold text-gray-700';
            totalLabel.textContent = 'TOTAL:';
            totalDiv.appendChild(totalLabel);
            
            const totalValue = document.createElement('span');
            totalValue.className = 'text-2xl font-bold text-gray-800';
            totalValue.textContent = `R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
            totalDiv.appendChild(totalValue);
            
            resumoContent.appendChild(totalDiv);
            resumoDiv.appendChild(resumoContent);
            container.appendChild(resumoDiv);
            
            // Lista de recibos
            const listaDiv = document.createElement('div');
            listaDiv.className = 'space-y-3';
            
            const listaTitle = document.createElement('h3');
            listaTitle.className = 'text-lg font-bold text-gray-800';
            listaTitle.textContent = `Recibos ${state.viewMode === 'mes' ? 'do M√™s' : 'do Ano'}`;
            listaDiv.appendChild(listaTitle);
            
            if (recibosContextuais.length === 0) {
                const emptyMsg = document.createElement('p');
                emptyMsg.className = 'text-center text-gray-600 py-8';
                emptyMsg.textContent = `Nenhum recibo encontrado para ${getDateLabel()}.`;
                listaDiv.appendChild(emptyMsg);
            } else {
                recibosContextuais
                    .sort((a, b) => new Date(b.data) - new Date(a.data))
                    .forEach(recibo => {
                        const reciboDiv = document.createElement('div');
                        reciboDiv.className = 'bg-white rounded-lg shadow p-4 border-l-4 border-l-blue-500';
                        
                        const reciboContent = document.createElement('div');
                        reciboContent.className = 'flex justify-between items-start';
                        
                        const leftDiv = document.createElement('div');
                        leftDiv.className = 'flex-1';
                        
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'flex items-center gap-2 mb-1';
                        
                        const nomeSpan = document.createElement('span');
                        nomeSpan.className = `px-2 py-1 rounded text-sm font-bold ${recibo.nome === 'Edna' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}`;
                        nomeSpan.textContent = recibo.nome;
                        headerDiv.appendChild(nomeSpan);
                        
                        const dataSpan = document.createElement('span');
                        dataSpan.className = 'text-sm text-gray-600';
                        dataSpan.textContent = new Date(recibo.data).toLocaleDateString('pt-BR');
                        headerDiv.appendChild(dataSpan);
                        
                        if (recibo.fotoNome) {
                            const fotoIcon = document.createElement('span');
                            fotoIcon.className = 'text-lg';
                            fotoIcon.textContent = 'üì∑';
                            headerDiv.appendChild(fotoIcon);
                        }
                        
                        leftDiv.appendChild(headerDiv);
                        
                        const descP = document.createElement('p');
                        descP.className = 'text-gray-800 font-medium';
                        descP.textContent = recibo.descricao;
                        leftDiv.appendChild(descP);
                        
                        const catP = document.createElement('p');
                        catP.className = 'text-sm text-gray-600';
                        catP.textContent = recibo.categoria;
                        leftDiv.appendChild(catP);
                        
                        const rightDiv = document.createElement('div');
                        rightDiv.className = 'text-right';
                        
                        const valorP = document.createElement('p');
                        valorP.className = 'text-lg font-bold text-green-600 mb-2';
                        valorP.textContent = `R$ ${recibo.valor.toFixed(2).replace('.', ',')}`;
                        rightDiv.appendChild(valorP);
                        
                        const buttonsDiv = document.createElement('div');
                        buttonsDiv.className = 'flex gap-2';
                        
                        if (recibo.fotoNome) {
                            const verFotoBtn = document.createElement('button');
                            verFotoBtn.textContent = 'üì∑';
                            verFotoBtn.className = 'text-blue-500 text-sm px-2 py-1 bg-blue-50 rounded font-bold';
                            verFotoBtn.onclick = () => {
                                carregarFotoInteligente(recibo.fotoNome).then(dados => {
                                    if (dados) {
                                        const popup = window.open('', '_blank');
                                        popup.document.write(`
                                            <html>
                                                <head><title>Foto do Recibo - ${recibo.descricao}</title></head>
                                                <body style="margin:0; display:flex; justify-content:center; align-items:center; min-height:100vh; background:#f3f4f6;">
                                                    <img src="${dados}" style="max-width:100%; max-height:100vh; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                                                </body>
                                            </html>
                                        `);
                                    } else {
                                        alert('Foto n√£o encontrada');
                                    }
                                }).catch(() => {
                                    alert('Erro ao carregar foto');
                                });
                            };
                            buttonsDiv.appendChild(verFotoBtn);
                        }
                        
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Editar';
                        editBtn.className = 'text-blue-500 text-sm px-2 py-1 bg-blue-50 rounded font-bold';
                        editBtn.onclick = () => editRecibo(recibo.id);
                        buttonsDiv.appendChild(editBtn);
                        
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Excluir';
                        delBtn.className = 'text-red-500 text-sm px-2 py-1 bg-red-50 rounded font-bold';
                        delBtn.onclick = () => deleteRecibo(recibo.id);
                        buttonsDiv.appendChild(delBtn);
                        
                        rightDiv.appendChild(buttonsDiv);
                        
                        reciboContent.appendChild(leftDiv);
                        reciboContent.appendChild(rightDiv);
                        reciboDiv.appendChild(reciboContent);
                        listaDiv.appendChild(reciboDiv);
                    });
            }
            
            container.appendChild(listaDiv);
            return container;
        }

        function createTelaRelatorios() {
            const container = document.createElement('div');
            container.className = 'p-4 space-y-6';
            
            const title = document.createElement('h2');
            title.className = 'text-2xl font-bold text-center text-gray-800';
            title.textContent = 'Relat√≥rios';
            container.appendChild(title);
            
            // Info per√≠odo
            const infoDiv = document.createElement('div');
            infoDiv.className = 'bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg shadow-lg p-4 text-white text-center';
            
            const infoP1 = document.createElement('p');
            infoP1.className = 'text-lg font-bold';
            infoP1.textContent = 'Visualizando:';
            infoDiv.appendChild(infoP1);
            
            const infoP2 = document.createElement('p');
            infoP2.className = 'text-xl';
            infoP2.textContent = getDateLabel();
            infoDiv.appendChild(infoP2);
            
            const infoP3 = document.createElement('p');
            infoP3.className = 'text-sm opacity-90';
            infoP3.textContent = `${getRecibosContextuais().length} recibos deste per√≠odo`;
            infoDiv.appendChild(infoP3);
            
            container.appendChild(infoDiv);
            
            // Compartilhamento
            const backupDiv = document.createElement('div');
            backupDiv.className = 'bg-gradient-to-r from-orange-500 to-red-600 rounded-lg shadow-lg p-6 text-white';
            
            const backupTitle = document.createElement('h3');
            backupTitle.className = 'text-xl font-bold mb-2 text-center';
            backupTitle.textContent = 'üì§ Backup Completo';
            backupDiv.appendChild(backupTitle);
            
            const backupDesc = document.createElement('p');
            backupDesc.className = 'text-center text-sm mb-4 opacity-90';
            backupDesc.textContent = `ZIP com todos os ${state.recibos.length} recibos + ${state.recibos.filter(r => r.fotoNome).length} fotos`;
            backupDiv.appendChild(backupDesc);
            
            const backupBtn = document.createElement('button');
            backupBtn.className = 'w-full py-4 bg-white text-orange-600 text-xl font-bold rounded-lg flex items-center justify-center gap-3';
            backupBtn.onclick = compartilharWhatsApp;
            
            const backupIcon = document.createElement('span');
            backupIcon.style.fontSize = '20px';
            backupIcon.textContent = 'üì§';
            backupBtn.appendChild(backupIcon);
            
            const backupText = document.createElement('span');
            backupText.textContent = 'COMPARTILHAR ZIP';
            backupBtn.appendChild(backupText);
            
            backupDiv.appendChild(backupBtn);
            
            const backupNote = document.createElement('p');
            backupNote.className = 'text-center text-sm mt-2 opacity-90';
            backupNote.textContent = 'Para WhatsApp, Email ou outras redes';
            backupDiv.appendChild(backupNote);
            
            container.appendChild(backupDiv);
            
            // Outras op√ß√µes
            const outrasDiv = document.createElement('div');
            outrasDiv.className = 'bg-white rounded-lg shadow p-4 space-y-3';
            
            const outrasTitle = document.createElement('h3');
            outrasTitle.className = 'text-lg font-bold text-gray-800 mb-3';
            outrasTitle.textContent = 'Outras Op√ß√µes';
            outrasDiv.appendChild(outrasTitle);
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'w-full py-3 bg-blue-500 text-white text-lg font-bold rounded-lg flex items-center justify-center gap-2';
            downloadBtn.onclick = () => exportarCSV('todos');
            
            const downloadIcon = document.createElement('span');
            downloadIcon.style.fontSize = '18px';
            downloadIcon.textContent = '‚¨áÔ∏è';
            downloadBtn.appendChild(downloadIcon);
            
            const downloadText = document.createElement('span');
            downloadText.textContent = 'BAIXAR CSV COMPLETO';
            downloadBtn.appendChild(downloadText);
            
            outrasDiv.appendChild(downloadBtn);
            
            // Bot√£o Backup Manual
            const backupManualBtn = document.createElement('button');
            backupManualBtn.className = 'w-full py-3 bg-orange-500 text-white text-lg font-bold rounded-lg flex items-center justify-center gap-2';
            backupManualBtn.onclick = () => {
                const nomeBackup = criarBackupSemanal();
                if (nomeBackup) {
                    alert(`‚úÖ Backup criado: ${nomeBackup}`);
                }
            };
            
            const backupManualIcon = document.createElement('span');
            backupManualIcon.style.fontSize = '18px';
            backupManualIcon.textContent = 'üíæ';
            backupManualBtn.appendChild(backupManualIcon);
            
            const backupManualText = document.createElement('span');
            backupManualText.textContent = 'CRIAR BACKUP MANUAL';
            backupManualBtn.appendChild(backupManualText);
            
            outrasDiv.appendChild(backupManualBtn);
            
            const exportAtualBtn = document.createElement('button');
            exportAtualBtn.className = 'w-full py-2 bg-gray-400 text-white text-sm font-medium rounded-lg flex items-center justify-center gap-2';
            exportAtualBtn.onclick = () => exportarCSV('atual');
            
            const exportIcon = document.createElement('span');
            exportIcon.style.fontSize = '16px';
            exportIcon.textContent = '‚¨áÔ∏è';
            exportAtualBtn.appendChild(exportIcon);
            
            const exportText = document.createElement('span');
            exportText.textContent = `Exportar Apenas ${state.viewMode === 'mes' ? 'M√™s' : 'Ano'} Atual`;
            exportAtualBtn.appendChild(exportText);
            
            outrasDiv.appendChild(exportAtualBtn);
            
            // Carregar backup
            const uploadLabel = document.createElement('label');
            uploadLabel.className = 'w-full py-3 bg-purple-500 text-white text-lg font-bold rounded-lg flex items-center justify-center gap-2 cursor-pointer';
            
            const uploadIcon = document.createElement('span');
            uploadIcon.style.fontSize = '18px';
            uploadIcon.textContent = '‚¨ÜÔ∏è';
            uploadLabel.appendChild(uploadIcon);
            
            const uploadText = document.createElement('span');
            uploadText.textContent = 'IMPORTAR CSV';
            uploadLabel.appendChild(uploadText);
            
            const uploadInput = document.createElement('input');
            uploadInput.type = 'file';
            uploadInput.accept = '.csv';
            uploadInput.className = 'hidden';
            uploadInput.addEventListener('change', carregarBackup);
            uploadLabel.appendChild(uploadInput);
            
            outrasDiv.appendChild(uploadLabel);
            container.appendChild(outrasDiv);
            
            // Estat√≠sticas
            const statsDiv = document.createElement('div');
            statsDiv.className = 'bg-white rounded-lg shadow-lg p-6';
            
            const statsTitle = document.createElement('h3');
            statsTitle.className = 'text-lg font-bold text-gray-800 mb-4';
            statsTitle.textContent = 'Estat√≠sticas Gerais';
            statsDiv.appendChild(statsTitle);
            
            const statsGrid = document.createElement('div');
            statsGrid.className = 'grid grid-cols-2 gap-4 text-center';
            
            const totalRecibos = document.createElement('div');
            totalRecibos.className = 'p-3 bg-gray-50 rounded-lg';
            
            const totalRecibosPNum = document.createElement('p');
            totalRecibosPNum.className = 'text-2xl font-bold text-blue-600';
            totalRecibosPNum.textContent = state.recibos.length.toString();
            totalRecibos.appendChild(totalRecibosPNum);
            
            const totalRecibosPText = document.createElement('p');
            totalRecibosPText.className = 'text-sm text-gray-600';
            totalRecibosPText.textContent = 'Total de Recibos';
            totalRecibos.appendChild(totalRecibosPText);
            
            statsGrid.appendChild(totalRecibos);
            
            const valorTotal = document.createElement('div');
            valorTotal.className = 'p-3 bg-gray-50 rounded-lg';
            
            const valorTotalPNum = document.createElement('p');
            valorTotalPNum.className = 'text-2xl font-bold text-green-600';
            valorTotalPNum.textContent = `R$ ${state.recibos.reduce((acc, r) => acc + r.valor, 0).toFixed(2).replace('.', ',')}`;
            valorTotal.appendChild(valorTotalPNum);
            
            const valorTotalPText = document.createElement('p');
            valorTotalPText.className = 'text-sm text-gray-600';
            valorTotalPText.textContent = 'Valor Total Geral';
            valorTotal.appendChild(valorTotalPText);
            
            statsGrid.appendChild(valorTotal);
            statsDiv.appendChild(statsGrid);
            container.appendChild(statsDiv);
            
            return container;
        }

        // Sistema de Backup Autom√°tico
        function iniciarTimerBackupSemanal() {
            try {
                // Verifica se j√° passou uma semana desde o √∫ltimo backup
                const ultimoBackup = localStorage.getItem('ultimo-backup-timestamp');
                const agora = Date.now();
                const umaSemana = 7 * 24 * 60 * 60 * 1000; // 7 dias em milissegundos
                
                if (!ultimoBackup || (agora - parseInt(ultimoBackup)) >= umaSemana) {
                    // Faz backup automaticamente se passou uma semana
                    setTimeout(() => {
                        console.log('Executando backup autom√°tico semanal...');
                        const nomeBackup = criarBackupSemanal();
                        if (nomeBackup) {
                            localStorage.setItem('ultimo-backup-timestamp', agora.toString());
                            console.log('‚úÖ Backup autom√°tico criado:', nomeBackup);
                        }
                    }, 5000); // Aguarda 5 segundos ap√≥s inicializa√ß√£o
                }
                
                // Configura timer para pr√≥xima verifica√ß√£o (verifica a cada hora)
                setInterval(() => {
                    const ultimoBackupAtual = localStorage.getItem('ultimo-backup-timestamp');
                    const agoraAtual = Date.now();
                    
                    if (!ultimoBackupAtual || (agoraAtual - parseInt(ultimoBackupAtual)) >= umaSemana) {
                        console.log('Executando backup autom√°tico semanal...');
                        const nomeBackup = criarBackupSemanal();
                        if (nomeBackup) {
                            localStorage.setItem('ultimo-backup-timestamp', agoraAtual.toString());
                            console.log('‚úÖ Backup autom√°tico criado:', nomeBackup);
                        }
                    }
                }, 60 * 60 * 1000); // Verifica a cada hora
                
            } catch (e) {
                console.log('Erro ao iniciar timer de backup:', e);
            }
        }

        // Service Worker para PWA
        function registrarServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                const CACHE_NAME = 'recibos-v1';
                const urlsToCache = ['/'];
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                        .then(cache => cache.addAll(urlsToCache))
                    );
                });
                
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                        .then(response => response || fetch(event.request))
                    );
                });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('‚úÖ Service Worker registrado'))
                    .catch(error => console.log('‚ùå Erro no Service Worker:', error));
            }
        }

        // Detectar instala√ß√£o PWA
        function mostrarBotaoInstalar() {
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Mostrar bot√£o de instalar
                const installBtn = document.createElement('button');
                installBtn.textContent = 'üì± INSTALAR APP';
                installBtn.className = 'fixed bottom-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg font-bold z-50 animate-bounce';
                installBtn.style.cssText = 'position: fixed; bottom: 80px; right: 16px; background: #10B981; color: white; padding: 8px 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: bold; z-index: 50; border: none; font-size: 14px;';
                
                installBtn.onclick = async () => {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('‚úÖ PWA instalada!');
                        installBtn.remove();
                    }
                    deferredPrompt = null;
                };
                
                document.body.appendChild(installBtn);
                
                // Remove bot√£o ap√≥s 15 segundos
                setTimeout(() => {
                    if (installBtn.parentNode) {
                        installBtn.remove();
                    }
                }, 15000);
            });
        }
        
        // Detec√ß√£o de dados vazios
        function detectarDadosVazios() {
            return state.recibos.length === 0;
        }
        
        function mostrarAlertaDadosVazios() {
            if (detectarDadosVazios()) {
                setTimeout(() => {
                    const resposta = confirm(
                        'üö® DADOS VAZIOS DETECTADOS\n\n' +
                        'Parece que voc√™ n√£o tem nenhum recibo salvo.\n\n' +
                        'üìã Se voc√™ j√° tinha recibos antes:\n' +
                        '‚Ä¢ Pode ter perdido dados por limpeza de cache\n' +
                        '‚Ä¢ Voc√™ pode importar um backup CSV\n\n' +
                        'üîÑ Quer importar seus dados agora?\n\n' +
                        'üí¨ Se precisar de ajuda, entre em contato com Felipe!'
                    );
                    
                    if (resposta) {
                        // Criar input de arquivo tempor√°rio
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.csv';
                        input.onchange = carregarBackup;
                        input.click();
                    }
                }, 2000); // Aguarda 2s para app carregar
            }
        }

        // Inicializa√ß√£o
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                loadData();
                render();
                iniciarTimerBackupSemanal();
                registrarServiceWorker();
                mostrarBotaoInstalar();
                mostrarAlertaDadosVazios();
            });
        } else {
            loadData();
            render();
            iniciarTimerBackupSemanal();
            registrarServiceWorker();
            mostrarBotaoInstalar();
            mostrarAlertaDadosVazios();
        }
    </script>
</body>
</html>